Message Manipulation API
========================

The Message Manipulation API allows developers to create applications
that can modify messages as they are sent to existing Fiesta lists.

A valid set of client credentials is required to use the message
manipulation API. To get client credentials, contact
`api@corp.fiesta.cc <mailto:api@corp.fiesta.cc>`_.

Message Hook
------------

The main point of interaction for the API is a *message hook*
specified by the application developer. The message hook is a URI that
Fiesta will post message data to. To set a message hook for your
application, email `api@corp.fiesta.cc <mailto:api@corp.fiesta.cc>`_.

Activation
----------

In order for a message to be posted to your application's message
hook, your application must be *activated* for that message. There are
several ways that an application can be activated:

- Per-message activation occurs when a message is sent to a group
  using a registered *plustag*. An example: your application has
  registered the plustag **+example** and a user sends a message to
  **list_name+example@fiesta.cc**.

- Per-list activation occurs when an application has been installed on
  a given Fiesta list and a message is sent to that list.

- Per-domain activation occurs when a message is sent to a list using
  a Fiesta custom-domain, and one of the domain's managers has
  installed the application on that domain.

Incoming Messages
-----------------

Incoming messages are posted to your application's message hook as
JSON data. An example message follows:

.. code-block:: js

  {
    group: {
      link: "/group/TTZsJb0k0y7BAAAL"
      name: "family"
    },
    subject: "Hi guys",
    content: "This is an example message."
  }

`subject` is the message's subject.

`content` is a text representation of the message's content. The
message text is processed to remove signatures and quoted text.

Responses
---------

There are several valid responses to an incoming message.

Responding with HTTP status code **204** (No Content) means that your
application does not wish to make any changes to the normal Fiesta
message-handling workflow. The message will be handled by Fiesta
as-is.

Responding with HTTP status code **202** (Accepted) means that your
application has handled the message, and Fiesta does not need to take
further action. The message will not be sent to the list or processed
by any downstream applications.

Responding with HTTP status code **200** (OK) means that your
application is responding with a (possibly modified) message to be
sent to the list. The response body is a JSON document describing the
message that Fiesta should send:

.. code-block:: js

  {
    subject: "Hi again",
    content: "This is another example message."
  }

If either `subject` or `content` is not present the default is the
corresponding value as originally posted to your application.

Security / Authorization
------------------------

The use of HTTPS for your message hook is recommended, but not
required.

Fiesta signs all of it's requests to your message hook, so you can
verify that posted messages are actually from Fiesta. There are three
relevant header fields included with each request:

- `X-Fiesta-Timestamp`: A UNIX timestamp (seconds since the epoch,
  UTC) generated by Fiesta before posting a message to your message
  hook.

- `X-Fiesta-Nonce`: A nonce generated for the request. Guaranteed to
  be unique per second.

- `X-Fiesta-Signature`: A hexadecimal HMAC-SHA256 signature.

The signature is constructed using your client secret as the HMAC
key. The message that gets signed is the concatenation of the nonce,
timestamp, and POST body. To verify the message, construct the HMAC
signature (using SHA-256 mode) and verify that the resulting hexdigest
matches the value of the `X-Fiesta-Signature` header. To prevent
replay attacks, you can optionally check that the timestamp is recent
and that the (timestamp, nonce) pair has not been used before.
